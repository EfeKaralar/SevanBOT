<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SevanBot</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #1a1a1a;
      --sidebar-bg: #111;
      --surface: #2a2a2a;
      --surface-hover: #333;
      --border: #3a3a3a;
      --text: #e8e8e8;
      --text-muted: #888;
      --accent: #7c6afb;
      --accent-hover: #6b59ea;
      --user-bubble: #2d3a6b;
      --bot-bubble: #2a2a2a;
      --danger: #c0392b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* ------------------------------------------------------------------ */
    /* Password screen                                                      */
    /* ------------------------------------------------------------------ */
    #auth-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: center;
      z-index: 100;
    }
    #auth-overlay.hidden { display: none; }
    .auth-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 36px 40px;
      width: 360px;
      text-align: center;
    }
    .auth-box h1 { font-size: 1.6rem; margin-bottom: 8px; }
    .auth-box p  { color: var(--text-muted); margin-bottom: 24px; font-size: 0.9rem; }
    .auth-box input {
      width: 100%; padding: 10px 14px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 1rem;
      margin-bottom: 12px; outline: none;
    }
    .auth-box input:focus { border-color: var(--accent); }
    .auth-box button {
      width: 100%; padding: 10px; background: var(--accent);
      border: none; border-radius: 8px; color: #fff;
      font-size: 1rem; cursor: pointer; font-weight: 600;
    }
    .auth-box button:hover { background: var(--accent-hover); }
    #auth-error { color: #e74c3c; font-size: 0.85rem; margin-top: 8px; min-height: 18px; }

    /* ------------------------------------------------------------------ */
    /* Sidebar                                                              */
    /* ------------------------------------------------------------------ */
    #sidebar {
      width: 260px; min-width: 260px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    #sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    #new-chat-btn {
      width: 100%; padding: 9px;
      background: var(--accent); border: none; border-radius: 8px;
      color: #fff; font-size: 0.9rem; cursor: pointer; font-weight: 600;
    }
    #new-chat-btn:hover { background: var(--accent-hover); }

    #conv-list {
      flex: 1; overflow-y: auto; padding: 8px;
    }
    #conv-list::-webkit-scrollbar { width: 4px; }
    #conv-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .conv-item {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 12px; border-radius: 8px;
      cursor: pointer; user-select: none;
    }
    .conv-item:hover { background: var(--surface-hover); }
    .conv-item.active { background: var(--surface); }
    .conv-title {
      flex: 1; font-size: 0.85rem; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }
    .conv-date { font-size: 0.72rem; color: var(--text-muted); }
    .conv-delete {
      opacity: 0; background: none; border: none;
      color: var(--text-muted); cursor: pointer; padding: 2px 4px;
      border-radius: 4px; font-size: 0.9rem; line-height: 1;
    }
    .conv-item:hover .conv-delete { opacity: 1; }
    .conv-delete:hover { color: var(--danger); background: rgba(192,57,43,0.15); }

    /* ------------------------------------------------------------------ */
    /* Main chat area                                                       */
    /* ------------------------------------------------------------------ */
    #main {
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
    }
    #chat-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 600; font-size: 1rem;
      color: var(--text-muted);
    }
    #messages {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
    }
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .msg-row {
      display: flex;
    }
    .msg-row.user { justify-content: flex-end; }
    .msg-row.assistant { justify-content: flex-start; }

    .bubble {
      max-width: 72%; padding: 12px 16px;
      border-radius: 16px; font-size: 0.9rem; line-height: 1.6;
      white-space: pre-wrap; word-break: break-word;
    }
    .msg-row.user .bubble {
      background: var(--user-bubble);
      border-bottom-right-radius: 4px;
    }
    .msg-row.assistant .bubble {
      background: var(--bot-bubble);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    /* Sources collapsible */
    .sources-toggle {
      margin-top: 10px; font-size: 0.78rem;
      color: var(--text-muted); cursor: pointer;
      user-select: none;
    }
    .sources-toggle:hover { color: var(--text); }
    .sources-list {
      display: none; margin-top: 6px;
      border-top: 1px solid var(--border); padding-top: 8px;
    }
    .sources-list.open { display: block; }
    .source-item {
      font-size: 0.78rem; color: var(--text-muted);
      padding: 3px 0;
    }
    .source-item strong { color: var(--text); }

    /* Typing indicator */
    .typing-dots { display: flex; gap: 4px; align-items: center; padding: 4px 0; }
    .typing-dots span {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--text-muted);
      animation: bounce 1.2s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30%            { transform: translateY(-6px); }
    }

    /* Streaming cursor */
    .stream-cursor {
      color: var(--accent);
      animation: blink-cursor 0.7s step-end infinite;
      margin-left: 1px;
    }
    @keyframes blink-cursor { 50% { opacity: 0; } }

    /* Welcome placeholder */
    #welcome {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 10px; color: var(--text-muted);
    }
    #welcome h2 { font-size: 1.4rem; color: var(--text); }
    #welcome p  { font-size: 0.9rem; }

    /* ------------------------------------------------------------------ */
    /* Input bar                                                            */
    /* ------------------------------------------------------------------ */
    #input-bar {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex; gap: 10px; align-items: flex-end;
    }
    #msg-input {
      flex: 1; padding: 10px 14px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-size: 0.95rem;
      resize: none; outline: none; max-height: 140px; min-height: 44px;
      line-height: 1.5; font-family: inherit;
    }
    #msg-input:focus { border-color: var(--accent); }
    #send-btn {
      padding: 10px 18px; background: var(--accent); border: none;
      border-radius: 10px; color: #fff; font-size: 0.95rem;
      cursor: pointer; font-weight: 600; white-space: nowrap;
      align-self: flex-end;
    }
    #send-btn:hover:not(:disabled) { background: var(--accent-hover); }
    #send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>

<!-- Password overlay -->
<div id="auth-overlay">
  <div class="auth-box">
    <h1>SevanBot</h1>
    <p>Sevan Nisanyan'ın yazılarına dayalı sohbet asistanı</p>
    <input type="password" id="password-input" placeholder="Şifre" />
    <button onclick="authenticate()">Giriş</button>
    <div id="auth-error"></div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar">
  <div id="sidebar-header">
    <button id="new-chat-btn" onclick="newConversation()">+ Yeni Sohbet</button>
  </div>
  <div id="conv-list"></div>
</div>

<!-- Main area -->
<div id="main">
  <div id="chat-header">SevanBot</div>
  <div id="messages">
    <div id="welcome">
      <h2>SevanBot</h2>
      <p>Sevan Nisanyan'ın makalelerinden yanıt almak için bir soru sorun.</p>
    </div>
  </div>
  <div id="input-bar">
    <textarea id="msg-input" placeholder="Bir soru yazın…" rows="1"></textarea>
    <button id="send-btn" onclick="sendMessage()">Gönder</button>
  </div>
</div>

<script>
  // -----------------------------------------------------------------------
  // State
  // -----------------------------------------------------------------------
  let password = localStorage.getItem('sb_password') || '';
  let currentConvId = localStorage.getItem('sb_conv_id') || null;
  let isStreaming = false;
  const API_BASE = '/sevanbot/api';

  // -----------------------------------------------------------------------
  // Startup
  // -----------------------------------------------------------------------
  (async function init() {
    if (password) {
      // Verify stored password is still valid
      const ok = await verifyPassword(password);
      if (ok) {
        showApp();
        await loadConversations();
        if (currentConvId) {
          await openConversation(currentConvId).catch(() => {
            currentConvId = null;
            localStorage.removeItem('sb_conv_id');
          });
        }
      } else {
        password = '';
        localStorage.removeItem('sb_password');
      }
    }
  })();

  // -----------------------------------------------------------------------
  // Auth
  // -----------------------------------------------------------------------
  async function verifyPassword(pw) {
    try {
      const res = await fetch(`${API_BASE}/conversations`, {
        headers: { 'Authorization': 'Bearer ' + pw }
      });
      return res.status !== 401;
    } catch {
      return false;
    }
  }

  async function authenticate() {
    const pw = document.getElementById('password-input').value.trim();
    if (!pw) return;
    const ok = await verifyPassword(pw);
    if (ok) {
      password = pw;
      localStorage.setItem('sb_password', pw);
      document.getElementById('auth-error').textContent = '';
      showApp();
      await loadConversations();
    } else {
      document.getElementById('auth-error').textContent = 'Hatalı şifre.';
    }
  }

  function showApp() {
    document.getElementById('auth-overlay').classList.add('hidden');
  }

  // Allow Enter key in password input
  document.getElementById('password-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') authenticate();
  });

  // -----------------------------------------------------------------------
  // API helpers
  // -----------------------------------------------------------------------
  function authHeaders() {
    return { 'Authorization': 'Bearer ' + password };
  }

  async function apiFetch(path, opts = {}) {
    const res = await fetch(`${API_BASE}${path}`, {
      ...opts,
      headers: { ...authHeaders(), ...(opts.headers || {}) }
    });
    if (!res.ok) throw new Error(`API error ${res.status}`);
    return res;
  }

  // -----------------------------------------------------------------------
  // Conversations
  // -----------------------------------------------------------------------
  async function loadConversations() {
    const res = await apiFetch('/conversations');
    const convs = await res.json();
    renderSidebar(convs);
  }

  function renderSidebar(convs) {
    const list = document.getElementById('conv-list');
    list.innerHTML = '';
    for (const c of convs) {
      const item = document.createElement('div');
      item.className = 'conv-item' + (c.id === currentConvId ? ' active' : '');
      item.dataset.id = c.id;

      const date = new Date(c.updated_at);
      const dateStr = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });

      item.innerHTML = `
        <div style="flex:1; overflow:hidden;">
          <div class="conv-title">${escHtml(c.title)}</div>
          <div class="conv-date">${dateStr} · ${c.message_count} mesaj</div>
        </div>
        <button class="conv-delete" onclick="deleteConv(event,'${c.id}')" title="Sil">✕</button>
      `;
      item.addEventListener('click', () => openConversation(c.id));
      list.appendChild(item);
    }
  }

  async function openConversation(id) {
    const res = await apiFetch(`/conversations/${id}`);
    const conv = await res.json();

    currentConvId = id;
    localStorage.setItem('sb_conv_id', id);

    // Mark active in sidebar
    document.querySelectorAll('.conv-item').forEach(el => {
      el.classList.toggle('active', el.dataset.id === id);
    });

    // Render messages
    const msgsEl = document.getElementById('messages');
    msgsEl.innerHTML = '';

    for (const msg of conv.messages) {
      if (msg.role === 'user') {
        appendMessageBubble('user', msg.content);
      } else {
        const bubble = appendMessageBubble('assistant', msg.content);
        if (msg.sources && msg.sources.length > 0) {
          appendSources(bubble, msg.sources);
        }
      }
    }
    scrollToBottom();
  }

  function newConversation() {
    currentConvId = null;
    localStorage.removeItem('sb_conv_id');
    document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
    const msgsEl = document.getElementById('messages');
    msgsEl.innerHTML = `
      <div id="welcome">
        <h2>SevanBot</h2>
        <p>Sevan Nisanyan'ın makalelerinden yanıt almak için bir soru sorun.</p>
      </div>`;
  }

  async function deleteConv(event, id) {
    event.stopPropagation();
    if (!confirm('Bu sohbeti silmek istediğinizden emin misiniz?')) return;
    await apiFetch(`/conversations/${id}`, { method: 'DELETE' });
    if (currentConvId === id) newConversation();
    await loadConversations();
  }

  // -----------------------------------------------------------------------
  // Sending messages
  // -----------------------------------------------------------------------
  async function sendMessage() {
    if (isStreaming) return;
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    input.style.height = 'auto';
    setSendDisabled(true);
    isStreaming = true;

    // Hide welcome screen
    const welcome = document.getElementById('welcome');
    if (welcome) welcome.remove();

    appendMessageBubble('user', text);

    // Add typing indicator
    const typingRow = document.createElement('div');
    typingRow.className = 'msg-row assistant';
    typingRow.id = 'typing-indicator';
    typingRow.innerHTML = `
      <div class="bubble">
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>`;
    document.getElementById('messages').appendChild(typingRow);
    scrollToBottom();

    let streamCtrl = null;

    try {
      const res = await fetch(`${API_BASE}/chat`, {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversation_id: currentConvId, message: text }),
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      // Replace typing indicator with live streaming bubble
      document.getElementById('typing-indicator')?.remove();
      streamCtrl = createStreamBubble();

      // Read SSE stream
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let sources = [];
      let eventType = null;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop(); // hold back any incomplete line

        for (const line of lines) {
          if (line.startsWith('event: ')) {
            eventType = line.slice(7).trim();
          } else if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6));
            if (eventType === 'token') {
              streamCtrl.appendToken(data.text);
            } else if (eventType === 'done') {
              currentConvId = data.conversation_id;
              localStorage.setItem('sb_conv_id', currentConvId);
              sources = data.sources || [];
            } else if (eventType === 'error') {
              streamCtrl.showError(data.message);
            }
            eventType = null;
          }
        }
      }

      streamCtrl.finalize();
      if (sources.length > 0) appendSources(streamCtrl.bubble, sources);
      await loadConversations();

    } catch (err) {
      document.getElementById('typing-indicator')?.remove();
      if (streamCtrl) {
        streamCtrl.showError(err.message);
      } else {
        appendMessageBubble('assistant', 'Bir hata oluştu: ' + err.message);
      }
    } finally {
      isStreaming = false;
      setSendDisabled(false);
      scrollToBottom();
    }
  }

  // -----------------------------------------------------------------------
  // DOM helpers
  // -----------------------------------------------------------------------

  /**
   * Create an assistant bubble with a live streaming cursor.
   * Returns a controller with appendToken / finalize / showError.
   *
   * Structure inside .bubble:
   *   <text-node>  ← raw accumulated text (pre-wrap preserves newlines)
   *   <span.stream-cursor>▌</span>  ← removed on finalize()
   */
  function createStreamBubble() {
    const row = document.createElement('div');
    row.className = 'msg-row assistant';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const textNode = document.createTextNode('');
    const cursor = document.createElement('span');
    cursor.className = 'stream-cursor';
    cursor.textContent = '▌';

    bubble.appendChild(textNode);
    bubble.appendChild(cursor);
    row.appendChild(bubble);
    document.getElementById('messages').appendChild(row);
    scrollToBottom();

    let accumulated = '';

    return {
      bubble,
      appendToken(token) {
        accumulated += token;
        textNode.nodeValue = accumulated; // O(1) — no DOM traversal
        scrollToBottom();
      },
      finalize() {
        cursor.remove();
      },
      showError(msg) {
        cursor.remove();
        textNode.nodeValue = 'Hata: ' + msg;
      },
    };
  }

  function appendMessageBubble(role, text) {
    const row = document.createElement('div');
    row.className = 'msg-row ' + role;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    row.appendChild(bubble);
    document.getElementById('messages').appendChild(row);
    scrollToBottom();
    return bubble;
  }

  function appendSources(bubble, sources) {
    const container = document.createElement('div');

    const toggle = document.createElement('div');
    toggle.className = 'sources-toggle';
    toggle.textContent = `▸ Kaynaklar (${sources.length})`;

    const list = document.createElement('div');
    list.className = 'sources-list';

    for (const s of sources) {
      const item = document.createElement('div');
      item.className = 'source-item';
      const score = s.score ? ` (${s.score.toFixed(3)})` : '';
      const date = s.date ? ` · ${s.date}` : '';
      item.innerHTML = `<strong>${escHtml(s.title)}</strong>${escHtml(date)}${escHtml(score)}`;
      list.appendChild(item);
    }

    toggle.addEventListener('click', () => {
      list.classList.toggle('open');
      toggle.textContent = list.classList.contains('open')
        ? `▾ Kaynaklar (${sources.length})`
        : `▸ Kaynaklar (${sources.length})`;
    });

    container.appendChild(toggle);
    container.appendChild(list);
    bubble.appendChild(container);
  }

  function scrollToBottom() {
    const el = document.getElementById('messages');
    el.scrollTop = el.scrollHeight;
  }

  function setSendDisabled(disabled) {
    document.getElementById('send-btn').disabled = disabled;
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // -----------------------------------------------------------------------
  // Input auto-resize + Enter to send
  // -----------------------------------------------------------------------
  const msgInput = document.getElementById('msg-input');

  msgInput.addEventListener('input', () => {
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 140) + 'px';
  });

  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>
</body>
</html>
